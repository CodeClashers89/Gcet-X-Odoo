{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - Rental ERP{% endblock %}

{% block content %}
<style>
    .product-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px 20px;
        animation: fadeIn 0.4s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .page-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        border-radius: 12px;
        padding: 25px 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        color: white;
    }

    .page-header h2 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .page-header h2::before {
        content: "üì¶";
        font-size: 32px;
    }

    .back-link {
        color: white;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255,255,255,0.15);
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        margin-top: 12px;
    }

    .back-link:hover {
        background: rgba(255,255,255,0.25);
        color: white;
        text-decoration: none;
    }

    .product-content-wrapper {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 30px;
        animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .product-info-section {
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 25px;
        margin-bottom: 25px;
    }

    .product-info-section:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
    }

    .section-header {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        color: white;
        padding: 12px 20px;
        margin: 0 -30px 20px -30px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .section-header:first-of-type {
        margin-top: -30px;
        border-radius: 12px 12px 0 0;
    }

    .product-detail {
        color: #555;
        line-height: 1.8;
        font-size: 15px;
    }

    .product-detail strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .category-badge {
        display: inline-block;
        background: #f0f0f0;
        color: #2c3e50;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        gap: 6px;
        animation: popIn 0.3s ease;
        margin-bottom: 15px;
    }

    @keyframes popIn {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .status-badge::before {
        content: "";
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-in-stock {
        background-color: #d4edda;
        color: #155724;
    }

    .status-in-stock::before {
        background-color: #28a745;
        animation: pulse 2s infinite;
    }

    .status-low-stock {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-low-stock::before {
        background-color: #ffc107;
    }

    .status-out-stock {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-out-stock::before {
        background-color: #dc3545;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .pricing-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-top: 15px;
    }

    .pricing-table thead {
        background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        color: white;
    }

    .pricing-table thead th {
        padding: 18px 20px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: none;
    }

    .pricing-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .pricing-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .pricing-table tbody td {
        padding: 20px;
        vertical-align: middle;
        color: #555;
    }

    .amount-cell {
        font-weight: 700;
        color: #27ae60;
        font-size: 16px;
    }

    .variant-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .variant-item:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .variant-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 15px;
    }

    .variant-sku {
        color: #7f8c8d;
        font-size: 13px;
        margin-top: 4px;
    }

    .availability-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 30px;
        margin-top: 25px;
        animation: slideUp 0.5s ease-out;
        animation-delay: 0.1s;
        animation-fill-mode: backwards;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 14px;
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 12px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        color: #2c3e50;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        outline: none;
    }

    .form-control:hover {
        border-color: #3498db;
        background-color: white;
    }

    .form-control:focus {
        border-color: #2c3e50;
        background-color: white;
        box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
    }

    .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        width: 100%;
        justify-content: center;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        color: white;
        text-decoration: none;
    }

    .action-btn:active {
        transform: translateY(0);
    }

    .add-cart-btn {
        background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        box-shadow: 0 2px 5px rgba(39, 174, 96, 0.3);
        padding: 14px 28px;
        font-size: 15px;
        margin-top: 15px;
    }

    .add-cart-btn:hover {
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
    }

    .availability-result {
        margin-top: 15px;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 14px;
        animation: popIn 0.3s ease;
        display: none;
    }

    .availability-result.success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
        display: block;
    }

    .availability-result.error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
        display: block;
    }

    @media (max-width: 768px) {
        .product-container {
            padding: 15px 10px;
        }

        .page-header {
            padding: 20px;
        }

        .page-header h2 {
            font-size: 22px;
        }

        .product-content-wrapper,
        .availability-section {
            padding: 20px;
        }

        .pricing-table {
            font-size: 12px;
        }

        .pricing-table thead th,
        .pricing-table tbody td {
            padding: 12px 10px;
        }
    }
</style>

<div class="product-container">
    <!-- Page Header -->
    <div class="page-header">
        <h2>{{ product.name }}</h2>
        <a href="{% url 'catalog:product_list' %}" class="back-link">‚Üê Back to Products</a>
    </div>

    <!-- Product Content -->
    <div class="product-content-wrapper">
        <!-- Vendor & Category -->
        <div class="product-info-section">
            <h3 class="section-header">Product Information</h3>
            
            {% if product.category %}
            <div class="product-detail">
                <strong>Category:</strong> <span class="category-badge">üìÅ {{ product.category.name }}</span>
            </div>
            {% endif %}

            {% if product.vendor %}
            <div class="product-detail">
                <strong>Vendor:</strong> {{ product.vendor.vendorprofile.company_name }}<br>
                <strong>Contact:</strong> {{ product.vendor.vendorprofile.phone }} | {{ product.vendor.email }}
            </div>
            {% endif %}

            <!-- Stock Status -->
            <div class="product-detail">
                <strong>Stock Status:</strong><br>
                {% if product.quantity_on_hand > 10 %}
                    <span class="status-badge status-in-stock">In Stock ({{ product.quantity_on_hand }} available)</span>
                {% elif product.quantity_on_hand > 0 %}
                    <span class="status-badge status-low-stock">Low Stock ({{ product.quantity_on_hand }} available)</span>
                {% else %}
                    <span class="status-badge status-out-stock">Out of Stock</span>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="product-detail">
                <strong>Description:</strong><br>
                {{ product.description }}
            </div>
        </div>

        <!-- Rental Pricing -->
        {% if daily_prices or weekly_prices or monthly_prices %}
        <div class="product-info-section">
            <h3 class="section-header">Rental Pricing</h3>
            <table class="pricing-table">
                <thead>
                    <tr>
                        <th>Duration</th>
                        <th>Price</th>
                    </tr>
                </thead>
                <tbody>
                    {% for price in daily_prices %}
                    <tr>
                        <td>{{ price.duration_value }} Day(s)</td>
                        <td><span class="amount-cell">‚Çπ{{ price.price|floatformat:2 }}</span></td>
                    </tr>
                    {% endfor %}
                    
                    {% for price in weekly_prices %}
                    <tr>
                        <td>{{ price.duration_value }} Week(s)</td>
                        <td><span class="amount-cell">‚Çπ{{ price.price|floatformat:2 }}</span></td>
                    </tr>
                    {% endfor %}
                    
                    {% for price in monthly_prices %}
                    <tr>
                        <td>{{ price.duration_value }} Month(s)</td>
                        <td><span class="amount-cell">‚Çπ{{ price.price|floatformat:2 }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- Variants -->
        {% if product.variants.all %}
        <div class="product-info-section">
            <h3 class="section-header">Available Variants</h3>
            {% for variant in product.variants.all %}
            <div class="variant-item">
                <div class="variant-name">{{ variant.variant_name }}</div>
                <div class="variant-sku">SKU: {{ variant.sku }}</div>
                {% if variant.quantity_on_hand > 0 %}
                    <span class="status-badge status-in-stock" style="margin-top: 8px;">In Stock ({{ variant.quantity_on_hand }})</span>
                {% else %}
                    <span class="status-badge status-out-stock" style="margin-top: 8px;">Out of Stock</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Availability Checker (Hidden for Vendors) -->
    {% if user.role != 'vendor' %}
    <div class="availability-section">
        <h3 class="section-header">Check Availability</h3>

        <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="datetime-local" id="checkStartDate" class="form-control">
        </div>

        <div class="form-group">
            <label class="form-label">End Date</label>
            <input type="datetime-local" id="checkEndDate" class="form-control">
        </div>

        <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" id="checkQuantity" class="form-control" min="1" value="1">
        </div>

        <button type="button" class="action-btn" onclick="checkAvailability()">
            ‚úì Check Availability
        </button>

        <div id="availabilityResult" class="availability-result"></div>

        <a href="{% url 'rentals:create_quotation' %}?product_id={{ product.id }}" class="action-btn add-cart-btn">
            ÔøΩ Create Query
        </a>
    </div>
    {% endif %}
</div>

<script>
function checkAvailability() {
    const productId = {{ product.id }};
    const startDate = document.getElementById('checkStartDate').value;
    const endDate = document.getElementById('checkEndDate').value;
    const quantity = document.getElementById('checkQuantity').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    const resultDiv = document.getElementById('availabilityResult');
    resultDiv.className = 'availability-result';
    resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking availability...';
    resultDiv.style.display = 'block';

    fetch(`{% url 'catalog:check_availability' %}?product_id=${productId}&start_date=${startDate}&end_date=${endDate}&quantity=${quantity}`)
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                resultDiv.className = 'availability-result success';
                let html = `<strong>‚úì ${data.message}</strong>`;
                if (data.pricing && data.pricing.daily_price) {
                    html += `<br><small>‚Çπ${data.pricing.daily_price} per day √ó ${data.pricing.duration_days} days = ‚Çπ${data.pricing.total_price}</small>`;
                }
                resultDiv.innerHTML = html;
            } else {
                resultDiv.className = 'availability-result error';
                resultDiv.innerHTML = `<strong>‚úó ${data.message}</strong>`;
            }
        })
        .catch(error => {
            resultDiv.className = 'availability-result error';
            resultDiv.innerHTML = `<strong>‚úó Error checking availability</strong>`;
            console.error('Error:', error);
        });
}

// Allow Enter key to check availability
document.getElementById('checkQuantity').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        checkAvailability();
    }
});

// Initialize animations on page load
document.addEventListener('DOMContentLoaded', function() {
    const sections = document.querySelectorAll('.product-info-section');
    sections.forEach((section, index) => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            section.style.transition = 'all 0.4s ease';
            section.style.opacity = '1';
            section.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
